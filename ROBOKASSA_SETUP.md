# Настройка интеграции Robokassa

## Описание

Интеграция с платежной системой Robokassa для оплаты курсов. Включает в себя:
- Кнопку оплаты на стороне клиента
- Обработку результатов оплаты на сервере
- Автоматическое обновление статуса пользователя после оплаты

## Настройка переменных окружения

### Клиентская часть (client/.env)

Создайте файл `.env` в папке `client/` со следующим содержимым:

```env
VITE_API_URL=https://api.kulzhabay.kz/api
VITE_ROBOKASSA_MERCHANT_LOGIN=ваш_merchant_login
VITE_ROBOKASSA_PASSWORD1=ваш_password1
VITE_ROBOKASSA_PASSWORD2=ваш_password2
VITE_ROBOKASSA_TEST_MODE=1
```

**Важно:**
- `VITE_ROBOKASSA_MERCHANT_LOGIN` - логин магазина в Robokassa
- `VITE_ROBOKASSA_PASSWORD1` - пароль #1 из настроек магазина
- `VITE_ROBOKASSA_PASSWORD2` - пароль #2 из настроек магазина (используется для проверки подписи результата)
- `VITE_ROBOKASSA_TEST_MODE=1` - тестовый режим (для продакшена установите `0`)

### Серверная часть (server/.env)

Добавьте в файл `.env` в папке `server/` следующие переменные:

```env
ROBOKASSA_MERCHANT_LOGIN=ваш_merchant_login
ROBOKASSA_PASSWORD1=ваш_password1
ROBOKASSA_PASSWORD2=ваш_password2
CLIENT_URL=https://kulzhabay.kz
```

**Важно:**
- Пароли должны совпадать с паролями в настройках магазина Robokassa
- `CLIENT_URL` - URL вашего клиентского приложения для редиректа после оплаты

## Настройка в личном кабинете Robokassa

1. Войдите в личный кабинет Robokassa
2. Перейдите в настройки магазина
3. Установите следующие URL:

### Result URL (обязательный)
```
https://api.kulzhabay.kz/api/robres
```
Этот URL используется Robokassa для отправки результата оплаты на ваш сервер.

**Метод:** GET или POST

### Success URL (опциональный)
```
https://kulzhabay.kz/robokassa_callback/success
```
Страница, на которую перенаправляется пользователь после успешной оплаты.

### Fail URL (опциональный)
```
https://kulzhabay.kz/robokassa_callback/fail
```
Страница, на которую перенаправляется пользователь при отмене или ошибке оплаты.

## Использование

### На клиенте

Компонент `RobokassaPayment` используется на странице пользователя:

```tsx
import { RobokassaPayment } from '../../components/RobokassaPayment';

// В компоненте
<RobokassaPayment 
  amount={5000} 
  description="Оплата курса TochkaLi"
/>
```

### Параметры компонента:
- `amount` (number) - сумма оплаты
- `description` (string) - описание платежа
- `className` (string, опционально) - дополнительные CSS классы

## Как это работает

1. **Пользователь нажимает кнопку "Оплатить курс"**
   - Генерируется уникальный ID счета (InvoiceID)
   - Формируется строка для подписи: `MerchantLogin:OutSum:InvoiceID:Password1:Shp_userId=userId`
   - Вычисляется MD5 хеш подписи
   - Пользователь перенаправляется на страницу оплаты Robokassa

2. **После успешной оплаты**
   - Robokassa отправляет результат на `ResultURL` (https://api.kulzhabay.kz/api/robres)
   - Сервер проверяет подпись с использованием Password2
   - Если подпись верна, обновляется статус пользователя в базе данных
   - Сервер отвечает `OK{InvId}`

3. **Пользователь видит страницу успеха**
   - Robokassa перенаправляет пользователя на `SuccessURL`
   - Отображается красивая страница с подтверждением оплаты

## Безопасность

- Пароли Robokassa хранятся в переменных окружения и не попадают в код
- Все результаты оплаты проверяются по MD5 подписи
- Password1 используется для генерации подписи при создании платежа
- Password2 используется для проверки подписи при получении результата

## Тестирование

В тестовом режиме (`VITE_ROBOKASSA_TEST_MODE=1`):
- Используется тестовая среда Robokassa
- Реальные деньги не списываются
- Можно использовать тестовые карты Robokassa

Для тестирования:
1. Установите `VITE_ROBOKASSA_TEST_MODE=1` в client/.env
2. Нажмите кнопку "Оплатить курс"
3. Используйте тестовые данные карты из документации Robokassa

## Дополнительные параметры

Компонент автоматически передает:
- `Shp_userId` - ID пользователя (если авторизован) для автоматического обновления статуса
- `SuccessURL` - URL страницы успеха
- `FailURL` - URL страницы ошибки

## Обработка на сервере

Контроллер `RobokassaController` обрабатывает три типа запросов:

1. **handleResult** - основной обработчик результата оплаты
2. **handleSuccess** - страница успешной оплаты
3. **handleFail** - страница отмененной/неудачной оплаты

### Обновление пользователя

При успешной оплате обновляются следующие поля:
- `hasPaid` = true
- `paymentDate` = текущая дата
- `paymentAmount` = сумма платежа
- `invoiceId` = ID счета

## Возможные ошибки

### "Ошибка при формировании ссылки оплаты"
- Проверьте, что все переменные окружения установлены
- Убедитесь, что пользователь авторизован

### "Bad Signature" на сервере
- Проверьте, что Password2 на сервере совпадает с паролем в Robokassa
- Убедитесь, что порядок параметров в строке подписи правильный

### Robokassa не отправляет результат
- Проверьте, что Result URL правильно настроен в личном кабинете
- Убедитесь, что сервер доступен по указанному URL
- Проверьте логи сервера

## Поддержка

При возникновении проблем:
1. Проверьте логи сервера (`console.log` в RobokassaController)
2. Проверьте логи браузера (консоль разработчика)
3. Убедитесь, что все URL в настройках Robokassa правильные
4. Проверьте, что пароли совпадают в .env и в Robokassa

## Структура файлов

```
client/
  └── src/
      └── components/
          └── RobokassaPayment.tsx    # Компонент кнопки оплаты
      └── pages/
          └── User/
              └── Main.tsx              # Страница с кнопкой оплаты

server/
  └── Controllers/
      └── RobokassaController.js       # Обработка результатов оплаты
  └── Models/
      └── User.js                       # Модель пользователя с полями оплаты
  └── index.js                          # Маршруты Robokassa
```

## API endpoints

- `POST/GET /api/robres` - Result URL для Robokassa
- `GET /api/robokassa/success` - Success URL
- `GET /api/robokassa/fail` - Fail URL

